# 02 系统设计说明

## 1. 设计目标

1. 保持对外接口稳定，支持内部模块演进。  
2. 保证工具执行可控，提供多级安全边界。  
3. 让本地 CLI、Gateway、渠道消息处理共享同一 Agent 核心。  
4. 在可维护性优先前提下逐步扩展能力（skills/channels/mcp/gui）。

## 2. 核心设计原则

### 2.1 Facade + 子系统解耦

`gearclaw_core` 作为 facade，屏蔽底层拆分细节；子系统以独立 crate 维护演进，减少跨模块耦合。

### 2.2 Agent 循环编排

Agent 采用“消息 → LLM → 工具调用 → 结果回注 → 再推理”的闭环。  
循环上限 15 次，属于防失控设计。

### 2.3 配置驱动

系统行为由 `Config` 主导：

1. 模型与 API 端点  
2. 工具安全等级  
3. 记忆启用与数据库路径  
4. 渠道触发策略  
5. Gateway 网络参数

### 2.4 错误分层

错误模型分为：

1. `DomainError`：业务语义错误（配置、工具、会话、记忆、MCP）  
2. `InfraError`：IO/网络/序列化/数据库等基础设施错误  
3. `GearClawError`：统一对外错误类型

## 3. 关键流程设计

### 3.1 配置与启动

1. 优先从指定路径加载配置；否则按默认路径查找。  
2. API Key 优先使用配置，其次环境变量。  
3. endpoint 若未显式配置且存在环境变量则覆盖默认值。

### 3.2 记忆检索注入

1. 当 `agent.memory_enabled=true` 时，对用户消息执行 Top-K 检索。  
2. 将相关片段拼接进 system prompt，提升回答上下文完整性。  
3. 检索失败降级为“无记忆上下文”，不阻断主流程。

### 3.3 工具执行安全

1. `deny`：工具禁用  
2. `allowlist`：命令及参数受限制（含注入 token 拦截）  
3. `full`：仅做输入合法性校验

### 3.4 Gateway 协议模型

协议帧分为 `req/res/event`，其中：

1. `req`：客户端请求方法（health/status/send/agent）  
2. `res`：方法响应（ok 或 error）  
3. `event`：服务端推送（含 `channel.message`）

## 4. 安全与边界

1. session id 有长度、字符集、路径穿越防护。  
2. 工具 allowlist 对高风险参数做显式拦截。  
3. Gateway 认证采用 token 校验（当前实现偏轻量）。  
4. 设备身份签名流程存在占位逻辑，后续可升级为完整签名验证。

## 5. 已知约束

1. MCP 当前默认 disabled，相关配置暂不会真正建立客户端连接。  
2. Discord 目前是主要可用渠道实现，其他平台仍在扩展阶段。  
3. GUI 与 workspace 默认构建流程分离，需按需启用。

## 6. 导航

- 上一篇：[`01-项目架构说明.md`](./01-项目架构说明.md)  
- 下一篇：[`03-扩展说明.md`](./03-扩展说明.md)
