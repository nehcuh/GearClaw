# 01 项目架构说明

## 1. 架构总览

GearClaw 采用 Rust workspace 多 crate 架构，核心是“**Agent 编排 + 子系统拆分 + 多入口运行形态**”。

主要运行入口：

1. `gearclaw_cli`：本地交互、单次执行、管理命令  
2. `gearclaw_gateway`：WebSocket 网关，承接外部请求与事件推送  
3. `gearclaw_gui`：桌面客户端（当前按需构建，不在默认 workspace 成员）

## 2. 工作区 crate 结构

### 2.1 核心编排层

1. `gearclaw_core`  
   - 暴露统一 API（`Agent`、`Config`、错误类型等）  
   - 保留对外稳定接口，并封装各子系统能力
2. `gearclaw_agent`  
   - 对 `gearclaw_core::agent` 的兼容导出层

### 2.2 子系统能力层

1. `gearclaw_llm`：LLM 请求/流式响应/embedding  
2. `gearclaw_tools`：命令执行与安全策略（deny/allowlist/full）  
3. `gearclaw_session`：会话持久化与 session id 安全校验  
4. `gearclaw_memory`：markdown 索引、向量检索、SQLite 存储  
5. `gearclaw_mcp`：MCP 能力封装（当前默认 disabled）

### 2.3 通道与网关层

1. `gearclaw_channels`：统一渠道适配器接口 + Discord 适配实现  
2. `gearclaw_gateway`：协议帧、方法路由、认证、事件广播、触发器

### 2.4 交互层

1. `gearclaw_cli`：主运维入口  
2. `gearclaw_gui`：图形交互入口（macOS + GPUI）

## 3. 关键调用链

### 3.1 CLI 交互链路

1. CLI 解析命令并加载配置  
2. 初始化 `Agent`（LLM、Tool、Session、Memory、Skill、MCP）  
3. `process_message` 进入 LLM 循环  
4. LLM 产生 tool calls 时由 `ToolRouter` 分发执行  
5. 写回 session，返回最终回答

### 3.2 Gateway 渠道链路

1. 平台消息进入 `ChannelAdapter`（如 Discord）  
2. Gateway 将消息广播为 `channel.message` 事件  
3. 根据触发配置判断是否触发 Agent  
4. Agent 处理消息并通过渠道适配器回发结果

## 4. 模块关系要点

1. `core` 是稳定 facade；真实实现尽量下沉到 `llm/tools/session/memory/mcp`。  
2. `gateway` 不直接绑定单平台实现，依赖 `ChannelAdapter` 抽象。  
3. `agent` 的工具循环最多 15 轮，防止无限递归。  
4. `memory` 与 `agent.memory_enabled` 联动：检索结果注入 system prompt。  
5. `mcp` 配置可存在，但当前构建能力默认禁用。

## 5. 当前状态说明

1. workspace 已完成核心拆分，CLI/Gateway/Channels 可用。  
2. GUI 代码存在且可单独构建，默认 workspace 成员中暂不启用。  
3. 认证与设备身份模块存在占位实现（后续可增强）。

## 6. 导航

- 上一篇：[`00-文档索引.md`](./00-文档索引.md)  
- 下一篇：[`02-系统设计说明.md`](./02-系统设计说明.md)
