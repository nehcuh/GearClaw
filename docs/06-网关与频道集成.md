# 06 网关与频道集成

## 1. 架构关系

Gateway 负责两类能力：

1. 对外 WebSocket 协议服务（请求/响应/事件）  
2. 对内桥接 ChannelAdapter，并可按触发规则调用 Agent

## 2. 协议概览

帧类型：

1. `req`：客户端请求  
2. `res`：请求响应  
3. `event`：服务端主动推送

常见方法：

1. `health`  
2. `status`  
3. `send`  
4. `agent`

常见事件：

1. `channel.message`  
2. `tick`  
3. `presence`  
4. `shutdown`

## 3. 启动 Gateway

```bash
cargo run -p gearclaw_cli -- gateway
```

可选参数：

```bash
cargo run -p gearclaw_cli -- gateway --host 127.0.0.1 --port 18789
```

## 4. 发送消息接口

目标格式统一为：

```text
platform:identifier
```

示例请求：

```json
{
  "type": "req",
  "data": {
    "id": "send-1",
    "method": "send",
    "params": {
      "target": "discord:123456789012345678",
      "message": "Hello from Gateway"
    }
  }
}
```

## 5. 渠道消息回流

1. 适配器上报 `IncomingMessage`  
2. Gateway 转换为 `channel.message` 并广播  
3. 若触发器命中，则异步调用 Agent  
4. Agent 结果通过渠道适配器回发

## 6. 认证现状

Gateway 当前采用 token 认证校验流程；开发模式可放开未认证请求。  
生产场景建议保持认证开启，并限制监听地址与访问来源。

## 7. 对接新平台步骤

1. 在 `channels` 实现新的 `ChannelAdapter`  
2. 启动时注册到 Gateway `register_channel`  
3. 联调 `send`、`on_message`、`resolve_target`  
4. 校验 `channel.message` 事件负载结构

## 8. 导航

- 上一篇：[`05-配置说明.md`](./05-配置说明.md)  
- 下一篇：[`07-Agent触发机制.md`](./07-Agent触发机制.md)
